---
title: 'vsftpd与一个客户的故事'
tags: vsftpd linux docker
key: 20180511
---

## 缘起
5.10 下午突然被拉进一个微信群，说客户有一个问题需要协助解决。这个客户是金域检验，是之前一直想突破的客户，看到这个地方，突然在想，可以由此问题入手，尝试建立客户关系。
<!--more-->
## 过程
### 客户问题描述
客户使用容器运行vsfptd搭建ftp服务，容器运行在华为云ECS主机，IaaS的兄弟分析结果是在虚拟机上没问题，在容器内有问题。
客户反馈了两个现象：
- 通过云服务器的弹性IP地址，可以访问控制端口，但是数据端口无法打开 （后来证明是vsfptd端口配置错误，且在云服务器的安全组上未打开端口）
- 通过暴露到ELB上可以访问，但是上传M级别的文件会卡住 （后来证明是客户公司网络限制）
ftp是标准协议，对网络也没有额外要求，肯定不是华为云基础网络的问题。
### 分析过程
- 5.10晚上在微信群与客户聊，了解到了问题现象，了解到了客户的目的，就是要搭一个ftp服务器
- 同时在群里面问到了客户使用的Docker镜像、启动Docker进程的命令
- 由于是与客户远程交流、最多只能电话，客户（郑俊杰）不是很友好，有点认定了就是华为云的问题；刚好田明第二天要去广州交流，因此确定策略：我在家里模拟客户操作通过vsftpd搭建一个ftp服务器，同时田明到客户现场去了解一下情况，顺便见一下客户
- 第二天11点多开始搭建环境，也出现了同样问题，心里有点担心
- 客户多次说使用的Passive模式，且问题也正是卡在切换到Paasive模式之后无法连接
- 查了一下到底什么是Passive与Port模式
- Passive是被动模式，通过控制端口（通常是21）连接到vsftpd之后，执行PASV命令，客户端会请求服务端打开一个数据端口，客户端再连接这个数据端口上传与下载文件
- Port模式是主动模式，客户端从一个任意的非特权端口N（N>;1024）连接到FTP服务器的命令端口，也就是21端口；然后客户端开始监听端口N+1，并发送FTP命令“port N+1”到FTP服务器；接着服务器会从它自己的数据端口（20）连接到客户端指定的数据端口（N+1）
- 应当是Paasive端口在安全组上没有放开，但是Passive端口号是多少？
- 到网上查了一下关键字 docker vsftpd passive，发现了这个issue，讨论vsftpd的镜像有一个未配置好Passvie端口的bug，但是已经修复了；同时得到了如何查看Passive端口的配置
- 登录到vsftpd容器中，发现这个镜像中默认的Passive端口与docker-proxy开的端口映射不一致，也就是外部通过docker-proxy进来之后无法转发到vsftpd容器中，导致了问题
- 修改启动命令，把映射端口修改为与vsftpd.conf中的一致，再次尝试，通了
- 叫客户试一下，客户说无法上传文件，还是有问题；客户反问你真的测试过了吗？我当时有点怒了，想一想没必要与他争执
- 应当是用户权限问题，没有权限写目录，且在容器中目录可能是只读的，因此要从外部挂接一个目录到容器中
- 但是容器中运行的用户是啥，想ps一下vsftpd进程，但是容器中居然没有这个命令，没办法，为了快，先把要mount进容器的host目录权限改为777
- 还有问题，vsftpd进程已经chroot了，chroot的目录是多少，到vsftpd.conf中查，是/srv
- 那就把host目录mount到容器的srv目录下去，上传文件，成功
- 叫客户试一下，客户还是反馈大文件挂住，并强调在AWS上同样搭建的vsftpd服务，没问题；从语气上来看就是认定了华为云有问题
- 有点蹊跷，我就自己上传了一个300M的文件，很顺利；这时候已经是下午2点了，3点还需要去见另外一个客户，刚好田明也到了客户那里，把相关信息与田明同步了一下，委托田明好好看看客户到底是怎么回事
- 田明也给力，折腾了两个小时后，发现是客户局域网有问题，连接AWS上的vsftpd也是有问题的
- 后来我叫田明反复确认客户是否认可是他们网络问题，客户认
- 到了晚上从客户那里回到办公室之后，把问题原因总结文档发给客户，客户说谢谢您，很详细
- 后来田明从广州返回深圳时候，在群里发了个广州南站照片，群里2个客户都说感谢
- 面对这种客户，我也不好说啥，回了客气了三个字
### 问题总结
#### 问题描述
使用docker运行vsftp服务器（vsftp镜像为：panubo/vsftpd），发现命令端口可以连接，但是数据端口无法连接。ftp模式为Passive。
#### 问题原因
使用的vsftpd镜像中配置的Passive端口与docker-proxy打开的端口不一致导致。

下图是vsftpd镜像中配置的Passive端口，范围为4559-4564：
![](/15-Hours/_image/docker-vsftpd-01.png)

而启动的时候配置的是21100-21110
![](/15-Hours/_image/docker-vsftpd-02.png)

#### 解决方法
因此，修改启动的端口范围，同时在云主机的安全组打开这个端口范围就可以了，参考下图：
1. 启动命令
```
sudo docker run --rm -it -p 8021:21 -p 4559-4564:4559-4564 -e FTP_USER=test -e FTP_PASSWORD=test -v /home/test:/srv panubo/vsftpd
```
2. 云主机安全组范围
![](/15-Hours/_image/docker-vsftpd-03.png)
同时，由于容器里面都是只读文件系统，如果ftp要上传文件，需要从host挂载目录到容器中，否则上传会报533错误码。
挂载host文件的时候，要保证容器里面的用户有host机器上目录的写权限，如果只是测试使用，可以把host目录权限改成777验证。

## 总结
- 不要和客户争执，无利于解决问题
- 跟一个客户就要主动，掌握全局
- 对于边界（IaaS，PaaS等）不要太在意，盯住目标；比如这次目标就是通过解决这个问题建立一个相对好一点的客户印象
- 客户说的话要仔细斟酌，带着怀疑一切的态度，去澄清；比如这次客户说在AWS上是好的，就有两个隐含意思：1）并没有试过；2）AWS上的vsftpd不是他搭建的。通过这两点，我判定郑俊杰并不是客户的技术骨干人员